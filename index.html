<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kidney Health Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@babel/standalone@7.24.0/babel.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif; /* A common Tailwind font */
      overscroll-behavior-y: contain; /* Prevents pull-to-refresh on mobile if scrolling within body */
      text-size-adjust: 100%; /* CSS compatibility fix */
      -webkit-text-size-adjust: 100%; /* For older Safari */
    }
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb {
      background: #888;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    /* Ensure charts with internal scrolling or fixed height behave */
    .chart-container {
        overflow-x: auto; /* For tables/charts that might be wide */
    }
    /* PDF Generation loading state */
    .pdf-generating-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
        color: white;
        font-size: 1.5rem;
    }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.3.1",
    "react-dom/client": "https://esm.sh/react-dom@18.3.1/client",
    "jspdf": "https://esm.sh/jspdf@2.5.1",
    "html2canvas": "https://esm.sh/html2canvas@1.4.1"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div id="root"></div>
  <div id="pdf-generating-indicator" class="pdf-generating-overlay" style="display: none;">
    Generating PDF, please wait...
  </div>

  <script type="text/babel" data-type="module" data-presets="react">
    import React, { useState, useEffect, useCallback, useMemo } from 'react';
    import ReactDOM from 'react-dom/client';
    import jsPDF from 'jspdf';
    import html2canvas from 'html2canvas';

    // --- START OF TYPES (commented out for pure JS, used for JSDoc/reference) ---
    // interface PatientData { age: number; gender: 'Male' | 'Female'; serumCreatinine: number; albuminuria: number; hasHypertension: boolean; hasDiabetes: boolean; }
    // interface CKDStage { stage: string; description: string; color: string; }
    // interface AlbuminuriaCategory { category: string; description: string; valueRange: string; }
    // interface KFRERiskLevel { level: 'Low' | 'Moderate' | 'High'; description: string; color: string; }
    // interface KidneyFunctionResults { egfr: number; ckdStage: CKDStage; albuminuria: number; albuminuriaCategory: AlbuminuriaCategory; kfre2yr: number; kfre5yr: number; kfre2yrRisk: KFRERiskLevel; kfre5yrRisk: KFRERiskLevel; adjustedKfre2yr: number; adjustedKfre5yr: number; }
    // interface Treatment { id: string; name: string; description: string; reduction: number; diabeticOnly?: boolean; }
    // interface TreatmentImpactRow { treatmentName: string; kfre2yr: number; kfre2yrChange: number; kfre5yr: number; kfre5yrChange: number; }
    // enum Gender { Male = 'Male', Female = 'Female' }
    // --- END OF TYPES ---

    // --- START OF CONSTANTS ---
    const Gender = { Male: 'Male', Female: 'Female' };

    const CKD_STAGES = {
      G1: { stage: 'G1', description: 'Normal or high', color: 'bg-green-500' },
      G2: { stage: 'G2', description: 'Mildly decreased', color: 'bg-lime-500' },
      G3a: { stage: 'G3a', description: 'Mildly to moderately decreased', color: 'bg-yellow-400' },
      G3b: { stage: 'G3b', description: 'Moderately to severely decreased', color: 'bg-amber-500' },
      G4: { stage: 'G4', description: 'Severely decreased', color: 'bg-orange-500' },
      G5: { stage: 'G5', description: 'Kidney failure', color: 'bg-red-600' },
    };

    const ALBUMINURIA_CATEGORIES = {
      A1: { category: 'A1', description: 'Normal to mildly increased', valueRange: '<30 mg/g' },
      A2: { category: 'A2', description: 'Moderately increased', valueRange: '30-300 mg/g' },
      A3: { category: 'A3', description: 'Severely increased', valueRange: '>300 mg/g' },
    };

    const KFRE_RISK_LEVELS = {
      Low: { level: 'Low', description: '<3%', color: 'text-green-600' },
      Moderate: { level: 'Moderate', description: '3% to <10%', color: 'text-yellow-600' },
      High: { level: 'High', description: '>=10%', color: 'text-red-600' },
    };

    const ALL_TREATMENTS = [
      { id: 'bp_control', name: 'Optimal BP Control', description: 'Reduces risk by 20%', reduction: 0.20 },
      { id: 'acei_arbs', name: 'ACEi/ARBs', description: 'Reduces risk by 30%', reduction: 0.30 },
      { id: 'sglt2', name: 'SGLT2 Inhibitors', description: 'Reduces risk by 45%', reduction: 0.45 },
      { id: 'mra', name: 'MRA (for diabetes)', description: 'Reduces risk by 20% if diabetic', reduction: 0.20, diabeticOnly: true },
    ];
    
    const KFRE_CHART_TREATMENT_ORDER = ALL_TREATMENTS;

    const EGFR_VISUALIZATION_STAGES = [
      { ...CKD_STAGES.G5, rangeMin: 0, rangeMax: 14, widthFactor: 15},
      { ...CKD_STAGES.G4, rangeMin: 15, rangeMax: 29, widthFactor: 15},
      { ...CKD_STAGES.G3b, rangeMin: 30, rangeMax: 44, widthFactor: 15},
      { ...CKD_STAGES.G3a, rangeMin: 45, rangeMax: 59, widthFactor: 15},
      { ...CKD_STAGES.G2, rangeMin: 60, rangeMax: 89, widthFactor: 30},
      { ...CKD_STAGES.G1, rangeMin: 90, rangeMax: 120, widthFactor: 30}, 
    ];
    const EGFR_VIS_MAX_VALUE = 120;
    // --- END OF CONSTANTS ---

    // --- START OF UI COMPONENTS ---
    const Card = ({ title, children, className, id }) => {
      return (
        <div id={id} className={`bg-white shadow-xl rounded-xl p-6 ${className}`}>
          {title && <h2 className="text-xl font-semibold text-slate-700 mb-4 border-b pb-2 border-slate-200">{title}</h2>}
          {children}
        </div>
      );
    };

    const Button = ({ children, variant = 'primary', className, ...props }) => {
      const baseStyles = "px-6 py-2.5 rounded-lg font-semibold shadow-md focus:outline-none focus:ring-2 focus:ring-opacity-75 transition-all duration-150 ease-in-out";
      let variantStyles = "";
      switch (variant) {
        case 'primary': variantStyles = "bg-indigo-600 hover:bg-indigo-700 text-white focus:ring-indigo-500 disabled:opacity-50"; break;
        case 'secondary': variantStyles = "bg-slate-200 hover:bg-slate-300 text-slate-700 focus:ring-slate-400 disabled:opacity-50"; break;
        case 'danger': variantStyles = "bg-red-500 hover:bg-red-600 text-white focus:ring-red-400 disabled:opacity-50"; break;
      }
      return <button className={`${baseStyles} ${variantStyles} ${className}`} {...props}>{children}</button>;
    };

    const Input = ({ label, id, unit, error, className, ...props }) => {
      return (
        <div className="mb-4">
          <label htmlFor={id} className="block text-sm font-medium text-slate-700 mb-1">
            {label} {unit && <span className="text-xs text-slate-500">({unit})</span>}
          </label>
          <input id={id} className={`w-full px-3 py-2 border ${error ? 'border-red-500' : 'border-slate-300'} rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm ${className}`} {...props} />
          {error && <p className="mt-1 text-xs text-red-600">{error}</p>}
        </div>
      );
    };

    const RadioGroup = ({ label, name, options, selectedValue, onChange }) => {
      return (
        <div className="mb-4">
          <p className="block text-sm font-medium text-slate-700 mb-1">{label}</p>
          <div className="flex space-x-4">
            {options.map(option => (
              <label key={option.value} className="flex items-center space-x-2 cursor-pointer">
                <input type="radio" name={name} value={option.value} checked={selectedValue === option.value} onChange={(e) => onChange(e.target.value)} className="h-4 w-4 text-indigo-600 border-slate-300 focus:ring-indigo-500" />
                <span className="text-sm text-slate-700">{option.label}</span>
              </label>
            ))}
          </div>
        </div>
      );
    };

    const Checkbox = ({ label, id, className, ...props }) => {
      return (
        <div className={`flex items-start ${className}`}>
          <div className="flex items-center h-5">
            <input id={id} type="checkbox" className="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-slate-300 rounded disabled:opacity-50" {...props} />
          </div>
          <div className="ml-3 text-sm">
            <label htmlFor={id} className={`font-medium text-slate-700 ${props.disabled ? 'text-slate-400 cursor-not-allowed' : 'cursor-pointer'}`}>{label}</label>
          </div>
        </div>
      );
    };
    // --- END OF UI COMPONENTS ---

    // --- START OF APP COMPONENTS ---
    const PatientInfoForm = ({ patientData, onDataChange, onSubmit }) => {
      const GENDER_OPTIONS = [{ value: Gender.Male, label: 'Male' }, { value: Gender.Female, label: 'Female' }];
      const YES_NO_OPTIONS = [{ value: 'Yes', label: 'Yes' }, { value: 'No', label: 'No' }];
      const handleSubmit = (e) => { e.preventDefault(); onSubmit(); };
      return (
        <Card title="Patient Information" className="sticky top-6">
          <form onSubmit={handleSubmit}>
            <Input label="Age" id="age" type="number" unit="years" value={patientData.age} onChange={(e) => onDataChange('age', parseInt(e.target.value) || 0)} min="1" max="120" required />
            <RadioGroup label="Gender" name="gender" options={GENDER_OPTIONS} selectedValue={patientData.gender} onChange={(value) => onDataChange('gender', value)} />
            <Input label="Serum Creatinine" id="serumCreatinine" type="number" step="0.01" unit="mg/dL" value={patientData.serumCreatinine} onChange={(e) => onDataChange('serumCreatinine', parseFloat(e.target.value) || 0)} min="0.1" max="20" required />
            <Input label="Albuminuria (ACR)" id="albuminuria" type="number" step="0.1" unit="mg/g" value={patientData.albuminuria} onChange={(e) => onDataChange('albuminuria', parseFloat(e.target.value) || 0)} min="0" max="5000" required />
            <p className="text-xs text-slate-500 -mt-3 mb-4">Enter exact value in mg/g.</p>
            <RadioGroup label="Hypertension" name="hypertension" options={YES_NO_OPTIONS} selectedValue={patientData.hasHypertension ? 'Yes' : 'No'} onChange={(value) => onDataChange('hasHypertension', value === 'Yes')} />
            <RadioGroup label="Diabetes" name="diabetes" options={YES_NO_OPTIONS} selectedValue={patientData.hasDiabetes ? 'Yes' : 'No'} onChange={(value) => onDataChange('hasDiabetes', value === 'Yes')} />
            <Button type="submit" className="w-full mt-2">Calculate Results</Button>
          </form>
        </Card>
      );
    };

    const ResultItem = ({ label, value, subValue, valueClass = "text-indigo-600" }) => (
      <div>
        <p className="text-sm text-slate-500">{label}</p>
        <p className={`text-2xl font-bold ${valueClass}`}>{value}</p>
        {subValue && <p className="text-xs text-slate-400">{subValue}</p>}
      </div>
    );

    const ResultsDisplay = ({ results, id }) => {
      return (
        <Card title="Kidney Function Results" id={id}>
          <div className="grid grid-cols-2 sm:grid-cols-3 gap-6">
            <ResultItem label="Estimated GFR" value={`${results.egfr}`} subValue="mL/min/1.73m²" />
            <ResultItem label="CKD Stage" value={results.ckdStage.stage} subValue={results.ckdStage.description} valueClass={results.ckdStage.color.replace('bg-', 'text-')} />
            <ResultItem label="Albuminuria" value={`${results.albuminuria} mg/g`} subValue={`Category: ${results.albuminuriaCategory.category} (${results.albuminuriaCategory.description})`} />
          </div>
        </Card>
      );
    };
    
    const EGFRVisualization = ({ egfr, ckdStage, id }) => {
      const safeEgfr = Math.min(Math.max(0, egfr), EGFR_VIS_MAX_VALUE);
      const markerPositionPercent = (safeEgfr / EGFR_VIS_MAX_VALUE) * 100;
      return (
        <Card title="eGFR Stage Visualization" id={id}>
          <div className="w-full relative pt-8 pb-4">
            <div className="flex h-8 rounded-md overflow-hidden bg-slate-200">
              {EGFR_VISUALIZATION_STAGES.map((stage) => (
                <div key={stage.stage} className={`${stage.color} flex items-center justify-center text-white text-xs font-semibold`} style={{ width: `${(stage.widthFactor / EGFR_VIS_MAX_VALUE) * 100}%` }} title={`${stage.stage}: ${stage.description} (${stage.rangeMin}-${stage.rangeMax}${stage.rangeMin === 90 ? '+' : ''})`}>
                  {stage.stage}
                </div>
              ))}
            </div>
            <div className="flex justify-between text-xs text-slate-500 mt-1 px-1"><span>0</span><span>30</span><span>60</span><span>90</span><span>120+</span></div>
            <div className="absolute h-full top-0 pt-0.5 transition-all duration-300 ease-out" style={{ left: `${markerPositionPercent}%`, transform: 'translateX(-50%)' }}>
              <div className="flex flex-col items-center"><span className="text-sm font-bold text-indigo-700 bg-white px-1.5 py-0.5 rounded shadow-md border border-indigo-300 -mt-7">{egfr}</span><div className="w-0.5 h-10 bg-indigo-700"></div></div>
            </div>
          </div>
        </Card>
      );
    };

    const RiskItem = ({ label, value, riskLevel, riskColor}) => (
      <div className="p-4 bg-slate-50 rounded-lg text-center shadow">
        <p className="text-sm text-slate-500">{label}</p>
        <p className={`text-3xl font-bold ${riskColor}`}>{value}</p>
        <p className={`text-xs font-semibold ${riskColor}`}>Risk: {riskLevel}</p>
      </div>
    );

    const RiskDisplay = ({ results }) => {
      return (
        <Card title="Kidney Failure Risk (KFRE)">
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <RiskItem label="2-Year KFRE" value={`${results.kfre2yr}%`} riskLevel={results.kfre2yrRisk.level} riskColor={results.kfre2yrRisk.color} />
            <RiskItem label="5-Year KFRE" value={`${results.kfre5yr}%`} riskLevel={results.kfre5yrRisk.level} riskColor={results.kfre5yrRisk.color} />
          </div>
        </Card>
      );
    };

    const SingleBarChart = ({ title, value, color, textColor, bgColor }) => {
        const MAX_RISK_DISPLAY = 60;
        const getBarHeight = (val) => `${(Math.min(val, MAX_RISK_DISPLAY) / MAX_RISK_DISPLAY) * 100}%`;
        const yAxisTicks = [0, 10, 20, 30, 40, 50, 60];

        return (
            <div className="text-center">
                <div className="h-64 w-full flex bg-slate-50 rounded-lg shadow-inner">
                    {/* Y-Axis Labels */}
                    <div className="w-12 pr-2 flex flex-col justify-between text-xs text-slate-500 py-2">
                        {yAxisTicks.slice().reverse().map(tick => (
                            <div key={`y-label-${tick}`} className="h-0 flex-1 relative">
                                <span className="absolute right-1 transform -translate-y-1/2">{tick}%</span>
                            </div>
                        ))}
                    </div>

                    {/* Chart Area */}
                    <div className="flex-1 relative p-4">
                        {/* Grid Lines */}
                        <div className="absolute inset-0 top-2 bottom-2 right-4 left-0 flex flex-col">
                            {yAxisTicks.slice(0, -1).map(tick => (
                                <div key={`grid-${tick}`} className="flex-1 border-b border-slate-200 border-dashed"></div>
                            ))}
                            <div className="flex-1"></div> 
                        </div>
                        
                        {/* Bar */}
                        <div className="relative w-full h-full flex items-end justify-center z-10">
                            <div 
                                className={`w-16 md:w-20 ${color} rounded-t-md hover:opacity-90 transition-all duration-300 ease-out`}
                                style={{ height: getBarHeight(value) }}
                                title={`${title}: ${value}%`}>
                            </div>
                        </div>
                    </div>
                </div>
                <p className="text-sm text-slate-600 mt-2 font-semibold">{title}</p>
                <p className={`text-lg font-bold ${textColor} ${bgColor} px-3 py-1 rounded-md inline-block mt-1`}>{value}%</p>
            </div>
        );
    };

    const KidneyFailureRiskChart = ({ kfre2yr, kfre5yr, id }) => {
        return (
            <Card title="Kidney Failure Risk (%) - Baseline" id={id}>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <SingleBarChart
                        title="2-Year Risk"
                        value={kfre2yr}
                        color="bg-sky-500"
                        textColor="text-sky-700"
                        bgColor="bg-sky-100"
                    />
                    <SingleBarChart
                        title="5-Year Risk"
                        value={kfre5yr}
                        color="bg-red-500"
                        textColor="text-red-700"
                        bgColor="bg-red-100"
                    />
                </div>
            </Card>
        );
    };


    const TreatmentImpactDetailsTable = ({ data, id }) => {
        if (!data || data.length === 0) return <p className="text-slate-500">No treatment impact data.</p>;
        const RiskChangeCell = ({ value, change }) => {
            const changeColor = change < 0 ? 'text-green-600' : change > 0 ? 'text-red-500' : 'text-slate-500';
            const arrow = change < 0 ? '↓' : change > 0 ? '↑' : '';
            return (<>{value.toFixed(1)}%{change !== 0 && <span className={`ml-1 text-xs ${changeColor}`}>({change > 0 ? '+' : ''}{change.toFixed(1)} {arrow})</span>}</>);
        };
        return (
            <div id={id} className="overflow-x-auto rounded-lg shadow border border-slate-200 chart-container">
                <table className="min-w-full divide-y divide-slate-200 bg-white">
                    <thead className="bg-slate-50"><tr><th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Treatment</th><th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">2-Year Risk</th><th className="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">5-Year Risk</th></tr></thead>
                    <tbody className="bg-white divide-y divide-slate-200">
                        {data.map((row) => (<tr key={row.treatmentName}><td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-slate-800">{row.treatmentName}</td><td className="px-4 py-3 whitespace-nowrap text-sm text-slate-600"><RiskChangeCell value={row.kfre2yr} change={row.kfre2yrChange} /></td><td className="px-4 py-3 whitespace-nowrap text-sm text-slate-600"><RiskChangeCell value={row.kfre5yr} change={row.kfre5yrChange} /></td></tr>))}
                    </tbody>
                </table>
            </div>
        );
    };

    const CumulativeTreatmentImpactLineChart = ({ data, id }) => {
        if (!data || data.length === 0) return <p className="text-slate-500 text-center py-4">No data.</p>;
        const plotData = data.filter(d => d.treatmentName !== 'Combined (Sequential)');
        const chartHeight = 300, chartWidth = 600;
        const padding = { top: 30, right: 30, bottom: 70, left: 50 };
        const yMax = Math.max(5, ...plotData.map(d => d.kfre2yr), ...plotData.map(d => d.kfre5yr)) * 1.1;
        const xPoints = plotData.length;
        const getX = (index) => padding.left + (index * (chartWidth - padding.left - padding.right)) / Math.max(1, xPoints - 1);
        const getY = (value) => chartHeight - padding.bottom - (value / yMax) * (chartHeight - padding.top - padding.bottom);
        const linePath = (kfreType) => plotData.map((d, i) => `${i === 0 ? 'M' : 'L'} ${getX(i)} ${getY(d[kfreType])}`).join(' ');
        const shortTreatmentName = (name) => {
            if (name === "Baseline") return "Baseline"; if (name.includes("BP Control")) return "BP Ctrl"; if (name.includes("ACEi/ARBs")) return "ACEi/ARB"; if (name.includes("SGLT2 Inhibitors")) return "SGLT2i"; if (name.includes("MRA")) return "MRA"; return name;
        };
        const yTicks = []; const numYTicks = 5;
        for (let i = 0; i <= numYTicks; i++) { const tickValue = (yMax / numYTicks) * i; yTicks.push({ value: tickValue, yPos: getY(tickValue) });}
        return (
            <div id={id} className="bg-white p-4 rounded-lg shadow border border-slate-200 chart-container">
                <svg width="100%" viewBox={`0 0 ${chartWidth} ${chartHeight}`} aria-labelledby="chartTitleLine" role="img">
                    <title id="chartTitleLine">Cumulative Sequential Treatment Impact on KFRE %</title>
                    {yTicks.map(tick => (<g key={`ytick-${tick.value}`}><line x1={padding.left - 5} y1={tick.yPos} x2={chartWidth - padding.right} y2={tick.yPos} stroke="#e2e8f0" strokeDasharray="2,2" /><text x={padding.left - 10} y={tick.yPos + 4} textAnchor="end" fontSize="10" fill="#64748b">{tick.value.toFixed(0)}%</text></g>))}
                    {plotData.map((d, i) => (<text key={`xlabel-${i}`} x={getX(i)} y={chartHeight - padding.bottom + 20} textAnchor="middle" fontSize="10" fill="#64748b">{shortTreatmentName(d.treatmentName)}</text>))}
                    <line x1={padding.left} y1={padding.top} x2={padding.left} y2={chartHeight - padding.bottom} stroke="#94a3b8" />
                    <line x1={padding.left} y1={chartHeight - padding.bottom} x2={chartWidth - padding.right} y2={chartHeight - padding.bottom} stroke="#94a3b8" />
                    <path d={linePath('kfre2yr')} stroke="#38bdf8" fill="none" strokeWidth="2" />
                    <path d={linePath('kfre5yr')} stroke="#f43f5e" fill="none" strokeWidth="2" />
                    {plotData.map((d, i) => (<React.Fragment key={`points-${i}`}><circle cx={getX(i)} cy={getY(d.kfre2yr)} r="4" fill="#38bdf8" stroke="white" strokeWidth="1"/><circle cx={getX(i)} cy={getY(d.kfre5yr)} r="4" fill="#f43f5e" stroke="white" strokeWidth="1"/></React.Fragment>))}
                    <g transform={`translate(${padding.left + 20}, ${padding.top - 20})`}><rect x="0" y="0" width="10" height="10" fill="#38bdf8" /><text x="15" y="9" fontSize="12" fill="#334155">2-Year Risk</text><rect x="100" y="0" width="10" height="10" fill="#f43f5e" /><text x="115" y="9" fontSize="12" fill="#334155">5-Year Risk</text></g>
                </svg>
            </div>
        );
    };

    const TreatmentImpactSection = ({ treatments, selectedTreatments, onTreatmentToggle, patientData, baseKFRE2yr, baseKFRE5yr, adjustedKFRE2yr, adjustedKFRE5yr, sequentialTreatmentData }) => {
        const TreatmentItem = ({treatment, isChecked, onToggle, disabled}) => {
            return (
                <div className={`p-4 rounded-lg flex items-center justify-between ${disabled ? 'bg-slate-100 opacity-70' : 'bg-slate-50 hover:bg-slate-100'} transition-colors`}>
                    <div><Checkbox id={`treatment-${treatment.id}`} label={<><span className="font-semibold">{treatment.name}</span><p className="text-xs text-slate-500">{treatment.description}</p></>} checked={isChecked} onChange={() => onToggle(treatment.id)} disabled={disabled} /></div>
                </div>);
        };
        const CumulativeImpactDisplay = ({ label, baseKFRE, adjustedKFRE }) => {
            const change = adjustedKFRE - baseKFRE; const changeDisplay = change.toFixed(1); const arrow = change < 0 ? '↓' : change > 0 ? '↑' : ''; const changeColor = change < 0 ? 'text-green-600' : change > 0 ? 'text-red-600' : 'text-slate-500'; const overallReductionPercent = baseKFRE > 0 ? ((baseKFRE - adjustedKFRE) / baseKFRE * 100) : 0;
            return (
                <div className="text-center p-3 bg-indigo-50 rounded-md"><p className="text-sm text-slate-600">{label}</p><p className="text-xl font-semibold text-indigo-700">{baseKFRE.toFixed(1)}% <span className="text-slate-400 mx-1">→</span> {adjustedKFRE.toFixed(1)}%</p><p className={`text-sm ${changeColor}`}>({change > 0 ? '+' : ''}{changeDisplay} points {arrow}, {overallReductionPercent.toFixed(1)}% reduction)</p></div>);
        };
        return (
            <Card title="Treatment Impact Simulation" className="mb-8">
                <p className="text-sm text-slate-600 mb-4">Select individual treatments below to see their combined impact on Kidney Failure Risk. Effects are cumulative based on your selections.</p>
                <div className="space-y-3 mb-6">{treatments.map(treatment => { const isDisabled = treatment.diabeticOnly && !patientData.hasDiabetes; const isChecked = selectedTreatments.includes(treatment.id) && !isDisabled; return (<TreatmentItem key={treatment.id} treatment={treatment} isChecked={isChecked} onToggle={onTreatmentToggle} disabled={isDisabled} />); })}</div>
                <h3 className="text-lg font-semibold text-slate-700 mb-3 pt-4 border-t border-slate-200">Cumulative Impact of Selected Treatments</h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8"><CumulativeImpactDisplay label="2-Year KFRE" baseKFRE={baseKFRE2yr} adjustedKFRE={adjustedKFRE2yr} /><CumulativeImpactDisplay label="5-Year KFRE" baseKFRE={baseKFRE5yr} adjustedKFRE={adjustedKFRE5yr} /></div>
                <h3 className="text-lg font-semibold text-slate-700 mb-3 pt-4 border-t border-slate-200">Sequential Treatment Impact Details</h3>
                <p className="text-xs text-slate-500 mb-3">The table and chart below illustrate the potential impact if standard treatments are applied sequentially.</p>
                <TreatmentImpactDetailsTable data={sequentialTreatmentData} id="treatment-impact-details-table-section" />
                <h3 className="text-lg font-semibold text-slate-700 mt-8 mb-3 pt-4 border-t border-slate-200">Cumulative Sequential Treatment Impact</h3>
                <CumulativeTreatmentImpactLineChart data={sequentialTreatmentData} id="treatment-impact-line-chart-section"/>
            </Card>
        );
    };

    const Disclaimer = () => (
        <Card className="bg-amber-50 border-amber-200 mt-8"><h3 className="text-md font-semibold text-amber-700 mb-2">DISCLAIMER</h3><p className="text-xs text-amber-600">This tool provides estimates based on established risk models. Results should be interpreted by healthcare professionals in the context of individual patient care. This tool is for informational purposes only and does not constitute medical advice.</p></Card>
    );
    const Footer = () => (
        <footer className="text-center py-8 mt-4"><p className="text-sm text-slate-500">For more information, visit <a href="https://www.nirogyams.com" target="_blank" rel="noopener noreferrer" className="text-indigo-600 hover:text-indigo-700 hover:underline font-medium">www.nirogyams.com</a></p></footer>
    );
    // --- END OF APP COMPONENTS ---

    // --- START OF App.js ---
    const App = () => {
      const [patientData, setPatientData] = useState({ age: 60, gender: 'Male', serumCreatinine: 1.2, albuminuria: 30, hasHypertension: true, hasDiabetes: true });
      const [results, setResults] = useState(null);
      const [selectedTreatments, setSelectedTreatments] = useState([]);
      const [isGeneratingPdf, setIsGeneratingPdf] = useState(false);

      const calculateEgfr = useCallback((data) => {
        const scr = data.serumCreatinine; const age = data.age; const isFemale = data.gender === 'Female';
        const CKD_EPI_COEFF = 141; const kappa = isFemale ? 0.7 : 0.9; const alpha = isFemale ? -0.329 : -0.411;
        const scr_ratio_power_gt_1 = -1.209; const age_factor_base = 0.993; const gender_multiplier = isFemale ? 1.018 : 1.0;
        const scr_div_kappa = scr / kappa;
        const term1_pow_alpha = Math.pow(Math.min(scr_div_kappa, 1), alpha);
        const term2_pow_factor = Math.pow(Math.max(scr_div_kappa, 1), scr_ratio_power_gt_1);
        const age_term = Math.pow(age_factor_base, age);
        const egfr_raw = CKD_EPI_COEFF * term1_pow_alpha * term2_pow_factor * age_term * gender_multiplier;
        return parseFloat(egfr_raw.toFixed(1));
      }, []);

      const getCKDStage = useCallback((egfr) => {
        if (egfr >= 90) return CKD_STAGES.G1; if (egfr >= 60) return CKD_STAGES.G2; if (egfr >= 45) return CKD_STAGES.G3a;
        if (egfr >= 30) return CKD_STAGES.G3b; if (egfr >= 15) return CKD_STAGES.G4; return CKD_STAGES.G5;
      }, []);

      const getAlbuminuriaCategory = useCallback((acr) => {
        if (acr < 30) return ALBUMINURIA_CATEGORIES.A1; if (acr <= 300) return ALBUMINURIA_CATEGORIES.A2; return ALBUMINURIA_CATEGORIES.A3;
      }, []);

      const calculateKFRE = useCallback((options) => {
        const { age, gender, egfr, acr, hasDiabetes, hasHypertension } = options;
        const sexCoeff = gender === 'Male' ? 1 : 0; const diabetesCoeff = hasDiabetes ? 1 : 0; const hypertensionCoeff = hasHypertension ? 1 : 0;
        const logAcr = Math.log(Math.max(0.1, acr)); // Ensure acr is not zero for log
        const lp = (-0.2218 * (age / 10 - 7.036)) + (0.2553 * (sexCoeff - 0.5642)) - (0.5541 * (egfr / 5 - 7.222)) + (0.4562 * (logAcr - 5.137)) - (0.1475 * (diabetesCoeff - 0.5106)) + (0.1426 * (hypertensionCoeff - 0.8501));
        const expLp = Math.exp(lp); const S0_2yr = 0.983; const kfre2yr_raw = 100 * (1 - Math.pow(S0_2yr, expLp));
        const S0_5yr = 0.9365; const kfre5yr_raw = 100 * (1 - Math.pow(S0_5yr, expLp));
        return { kfre2yr: parseFloat(Math.min(100, Math.max(0, kfre2yr_raw)).toFixed(1)), kfre5yr: parseFloat(Math.min(100, Math.max(0, kfre5yr_raw)).toFixed(1)) };
      }, []);

      const getKFRERiskLevel = useCallback((kfre) => {
        if (kfre < 3) return KFRE_RISK_LEVELS.Low; if (kfre < 10) return KFRE_RISK_LEVELS.Moderate; return KFRE_RISK_LEVELS.High;
      }, []);

      const calculateResults = useCallback(() => {
        const currentEgfr = calculateEgfr(patientData); const ckdStage = getCKDStage(currentEgfr); const albuminuriaCategory = getAlbuminuriaCategory(patientData.albuminuria);
        const { kfre2yr, kfre5yr } = calculateKFRE({ age: patientData.age, gender: patientData.gender, egfr: currentEgfr, acr: patientData.albuminuria, hasDiabetes: patientData.hasDiabetes, hasHypertension: patientData.hasHypertension });
        const kfre2yrRisk = getKFRERiskLevel(kfre2yr); const kfre5yrRisk = getKFRERiskLevel(kfre5yr);
        let currentTotalReductionFactor = 1.0;
        selectedTreatments.forEach(treatmentId => { const treatment = ALL_TREATMENTS.find(t => t.id === treatmentId); if (treatment && !(treatment.diabeticOnly && !patientData.hasDiabetes)) { currentTotalReductionFactor *= (1 - treatment.reduction); } });
        const adjustedKfre2yr = parseFloat(Math.min(100, Math.max(0, kfre2yr * currentTotalReductionFactor)).toFixed(1));
        const adjustedKfre5yr = parseFloat(Math.min(100, Math.max(0, kfre5yr * currentTotalReductionFactor)).toFixed(1));
        setResults({ egfr: currentEgfr, ckdStage, albuminuria: patientData.albuminuria, albuminuriaCategory, kfre2yr, kfre5yr, kfre2yrRisk, kfre5yrRisk, adjustedKfre2yr, adjustedKfre5yr });
      }, [patientData, calculateEgfr, getCKDStage, getAlbuminuriaCategory, calculateKFRE, getKFRERiskLevel, selectedTreatments]);

      useEffect(() => { calculateResults(); }, [calculateResults]);

      const sequentialTreatmentImpactData = useMemo(() => {
        if (!results) return []; const data = []; let currentKFRE2yr = results.kfre2yr; let currentKFRE5yr = results.kfre5yr;
        data.push({ treatmentName: 'Baseline', kfre2yr: results.kfre2yr, kfre2yrChange: 0, kfre5yr: results.kfre5yr, kfre5yrChange: 0 });
        KFRE_CHART_TREATMENT_ORDER.forEach(treatment => {
          const isApplicable = !(treatment.diabeticOnly && !patientData.hasDiabetes);
          if (isApplicable) {
            const prevKFRE2yr = currentKFRE2yr; const prevKFRE5yr = currentKFRE5yr;
            currentKFRE2yr = parseFloat((prevKFRE2yr * (1 - treatment.reduction)).toFixed(1)); currentKFRE5yr = parseFloat((prevKFRE5yr * (1 - treatment.reduction)).toFixed(1));
            currentKFRE2yr = Math.max(0, Math.min(100, currentKFRE2yr)); currentKFRE5yr = Math.max(0, Math.min(100, currentKFRE5yr));
            data.push({ treatmentName: treatment.name.replace(' (for diabetes)','').replace('Optimal ',''), kfre2yr: currentKFRE2yr, kfre2yrChange: parseFloat((currentKFRE2yr - prevKFRE2yr).toFixed(1)), kfre5yr: currentKFRE5yr, kfre5yrChange: parseFloat((currentKFRE5yr - prevKFRE5yr).toFixed(1)) });
          }
        });
        return data;
      }, [results, patientData.hasDiabetes]);

      const handlePatientDataChange = (field, value) => setPatientData(prev => ({ ...prev, [field]: value }));
      const handleTreatmentToggle = (treatmentId) => setSelectedTreatments(prev => prev.includes(treatmentId) ? prev.filter(id => id !== treatmentId) : [...prev, treatmentId]);

      const handleDownloadPdf = async () => {
        if (!results) { alert("Please calculate results first."); return; }
        
        document.getElementById('pdf-generating-indicator').style.display = 'flex';
        setIsGeneratingPdf(true);

        const pdf = new jsPDF('p', 'mm', 'a4');
        const FONT_SIZE_NORMAL = 10, FONT_SIZE_LARGE = 14, FONT_SIZE_SMALL = 8, FONT_SIZE_TITLE = 18;
        const MARGIN = 15, IMAGE_QUALITY = 1, IMAGE_SCALE = 2;
        let yPos = MARGIN;

        const addTextWithYUpdate = (text, x, currentY, options = {}) => {
            const fontSize = options.fontSize || FONT_SIZE_NORMAL;
            const lineHeightFactor = 1.2; 
            const textArray = Array.isArray(text) ? text : [text];
            let newY = currentY;

            pdf.setFontSize(fontSize);
            textArray.forEach(line => {
                pdf.text(line, x, newY, options);
                newY += fontSize * 0.352778 * lineHeightFactor; 
            });
            return newY + (textArray.length > 0 ? 2 : 0) ; 
        };
        
        const addSectionTitle = (title, currentY) => {
            let newY = currentY;
            if (newY > 297 - MARGIN - 20) { pdf.addPage(); newY = MARGIN; }
            pdf.setFontSize(FONT_SIZE_LARGE); pdf.setTextColor(40, 56, 108);
            newY = addTextWithYUpdate(title, MARGIN, newY, { fontSize: FONT_SIZE_LARGE });
            newY += 1; 
            pdf.setDrawColor(200, 200, 200); pdf.line(MARGIN, newY, 210 - MARGIN, newY);
            newY += 3;
            pdf.setFontSize(FONT_SIZE_NORMAL); pdf.setTextColor(51, 65, 85);
            return newY;
        };

        const addImageToPdf = async (elementId) => {
            const element = document.getElementById(elementId);
            if (element) {
                const canvas = await html2canvas(element, { scale: IMAGE_SCALE, backgroundColor: '#f8fafc', useCORS: true, logging: false });
                const imgData = canvas.toDataURL('image/png', IMAGE_QUALITY);
                const imgProps = pdf.getImageProperties(imgData);
                const pdfWidth = 210 - 2 * MARGIN; 
                const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
                if (yPos + pdfHeight > 297 - MARGIN -5) { pdf.addPage(); yPos = MARGIN; } 
                pdf.addImage(imgData, 'PNG', MARGIN, yPos, pdfWidth, pdfHeight);
                yPos += pdfHeight + 5;
            }
        };
        
        pdf.setFont('helvetica', 'normal');

        pdf.setTextColor(67, 56, 202);
        const reportTitle = 'Kidney Health Dashboard Report';
        const titleWidth = pdf.getStringUnitWidth(reportTitle) * FONT_SIZE_TITLE / pdf.internal.scaleFactor;
        yPos = addTextWithYUpdate(reportTitle, (210 - titleWidth) / 2, yPos, { fontSize: FONT_SIZE_TITLE });
        
        pdf.setTextColor(100, 116, 139);
        const currentDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
        const dateText = `Date: ${currentDate}`;
        const dateWidth = pdf.getStringUnitWidth(dateText) * FONT_SIZE_NORMAL / pdf.internal.scaleFactor;
        yPos = addTextWithYUpdate(dateText, (210 - dateWidth) / 2, yPos, { fontSize: FONT_SIZE_NORMAL });
        yPos += 5;

        yPos = addSectionTitle('Patient Information', yPos);
        const patientInfoLines = [`Age: ${patientData.age} years`, `Gender: ${patientData.gender}`, `Serum Creatinine: ${patientData.serumCreatinine} mg/dL`, `Albuminuria (ACR): ${patientData.albuminuria} mg/g`, `Hypertension: ${patientData.hasHypertension ? 'Yes' : 'No'}`, `Diabetes: ${patientData.hasDiabetes ? 'Yes' : 'No'}`];
        patientInfoLines.forEach(line => { yPos = addTextWithYUpdate(line, MARGIN, yPos); });
        yPos += 2;

        yPos = addSectionTitle('Kidney Function Results', yPos);
        yPos = addTextWithYUpdate(`Estimated GFR (eGFR): ${results.egfr} mL/min/1.73m²`, MARGIN, yPos);
        yPos = addTextWithYUpdate(`CKD Stage: ${results.ckdStage.stage} (${results.ckdStage.description})`, MARGIN, yPos);
        yPos = addTextWithYUpdate(`Albuminuria: ${results.albuminuria} mg/g (Category: ${results.albuminuriaCategory.category} - ${results.albuminuriaCategory.description})`, MARGIN, yPos);
        yPos += 2;
        
        yPos = addSectionTitle('Baseline Kidney Failure Risk (KFRE)', yPos);
        yPos = addTextWithYUpdate(`2-Year KFRE: ${results.kfre2yr}% (Risk: ${results.kfre2yrRisk.level})`, MARGIN, yPos);
        yPos = addTextWithYUpdate(`5-Year KFRE: ${results.kfre5yr}% (Risk: ${results.kfre5yrRisk.level})`, MARGIN, yPos);
        
        await addImageToPdf('kfre-baseline-chart-section-pdf'); 
        
        pdf.addPage(); yPos = MARGIN;
        yPos = addSectionTitle('Treatment Impact Simulation', yPos);
        
        pdf.setFont('helvetica', 'italic');
        yPos = addTextWithYUpdate("The following charts illustrate the potential impact if standard treatments are applied sequentially based on the patient's profile.", MARGIN, yPos, { fontSize: FONT_SIZE_SMALL });
        pdf.setFont('helvetica', 'normal');
        yPos += 2;

        await addImageToPdf('treatment-impact-details-table-section');
        await addImageToPdf('treatment-impact-line-chart-section');

        if (yPos > 297 - MARGIN - 40) { pdf.addPage(); yPos = MARGIN; } 
        yPos = addSectionTitle('Disclaimer', yPos);
        const disclaimerText = "This tool provides estimates based on established risk models. Results should be interpreted by healthcare professionals in the context of individual patient care. This tool is for informational purposes only and does not constitute medical advice.";
        const splitDisclaimer = pdf.splitTextToSize(disclaimerText, 210 - 2 * MARGIN);
        addTextWithYUpdate(splitDisclaimer, MARGIN, yPos, { fontSize: FONT_SIZE_SMALL });
        
        pdf.save(`Kidney_Health_Report_${new Date().toISOString().slice(0,10)}.pdf`);
        document.getElementById('pdf-generating-indicator').style.display = 'none';
        setIsGeneratingPdf(false);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-sky-100 via-indigo-50 to-purple-100 py-6 sm:py-12">
          <div className="container mx-auto px-4 max-w-5xl">
            <header className="text-center mb-10"><h1 className="text-4xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-500 via-indigo-600 to-purple-700">Kidney Health Dashboard</h1><p className="text-lg text-slate-600 mt-2">Monitor kidney function, assess risk, and understand treatment impacts.</p></header>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
              <div className="md:col-span-1"><PatientInfoForm patientData={patientData} onDataChange={handlePatientDataChange} onSubmit={calculateResults} /></div>
              <div className="md:col-span-2 space-y-6">
                {results && (<>
                    <ResultsDisplay results={results} id="results-display-section-pdf" />
                    <EGFRVisualization egfr={results.egfr} ckdStage={results.ckdStage} id="egfr-visualization-section-pdf" />
                    <RiskDisplay results={results} />
                    <KidneyFailureRiskChart kfre2yr={results.kfre2yr} kfre5yr={results.kfre5yr} id="kfre-baseline-chart-section-pdf"/>
                </>)}
              </div>
            </div>
            {results && <TreatmentImpactSection treatments={ALL_TREATMENTS} selectedTreatments={selectedTreatments} onTreatmentToggle={handleTreatmentToggle} patientData={patientData} baseKFRE2yr={results.kfre2yr} baseKFRE5yr={results.kfre5yr} adjustedKFRE2yr={results.adjustedKfre2yr} adjustedKFRE5yr={results.adjustedKfre5yr} sequentialTreatmentData={sequentialTreatmentImpactData} />}
            <div className="text-center mt-8 mb-4"><Button onClick={handleDownloadPdf} variant="secondary" disabled={isGeneratingPdf || !results}>{isGeneratingPdf ? 'Generating...' : 'Download Report (PDF)'}</Button></div>
            <Disclaimer /><Footer />
          </div>
        </div>);
    };
    // --- END OF App.js ---

    const rootElement = document.getElementById('root');
    if (!rootElement) throw new Error("Root element not found");
    const root = ReactDOM.createRoot(rootElement);
    root.render(<App />);
  </script>
</body>
</html>
